From 61726252b0d8e702ed794b243c4824840b573b11 Mon Sep 17 00:00:00 2001
From: hepengpx <pengpengx.he@intel.com>
Date: Mon, 11 Nov 2024 16:39:16 +0800
Subject: [PATCH 6/9] i2c: media: fix cov issue

check return value of v4l2_ctrl_handler_init;
change the type of phy_port to int;

Signed-off-by: hepengpx <pengpengx.he@intel.com>
Signed-off-by: zouxiaoh <xiaohong.zou@intel.com>
---
 drivers/media/i2c/ti960-des.c                    | 14 +++++++-------
 drivers/media/pci/intel/ipu6/ipu6-isys-mcd-phy.c |  3 ++-
 2 files changed, 9 insertions(+), 8 deletions(-)

diff --git a/drivers/media/i2c/ti960-des.c b/drivers/media/i2c/ti960-des.c
index c36ff824b99b..a5efd87b7650 100644
--- a/drivers/media/i2c/ti960-des.c
+++ b/drivers/media/i2c/ti960-des.c
@@ -1482,7 +1482,7 @@ static struct v4l2_subdev_ops ti960_sd_ops = {
 
 static int ti960_register_subdev(struct ti960 *va)
 {
-	int i, rval;
+	int i, ret;
 	struct i2c_client *client = v4l2_get_subdevdata(&va->sd);
 
 	v4l2_subdev_init_finalize(&va->sd);
@@ -1496,10 +1496,10 @@ static int ti960_register_subdev(struct ti960 *va)
 
 	v4l2_set_subdevdata(&va->sd, client);
 
-	v4l2_ctrl_handler_init(&va->ctrl_handler,
+	ret = v4l2_ctrl_handler_init(&va->ctrl_handler,
 				ARRAY_SIZE(ti960_controls));
 
-	if (va->ctrl_handler.error) {
+	if (ret < 0) {
 		dev_err(va->sd.dev,
 			"Failed to init ti960 controls. ERR: %d!\n",
 			va->ctrl_handler.error);
@@ -1517,7 +1517,7 @@ static int ti960_register_subdev(struct ti960 *va)
 		if (!ctrl) {
 			dev_err(va->sd.dev,
 				"Failed to create ctrl %s!\n", cfg->name);
-			rval = va->ctrl_handler.error;
+			ret = va->ctrl_handler.error;
 			goto failed_out;
 		}
 	}
@@ -1545,9 +1545,9 @@ static int ti960_register_subdev(struct ti960 *va)
 	for (i = 0; i < va->nsinks; i++)
 		va->pad[i].flags = MEDIA_PAD_FL_SINK;
 	va->pad[TI960_PAD_SOURCE].flags = MEDIA_PAD_FL_SOURCE;
-	rval = media_entity_pads_init(&va->sd.entity,
+	ret = media_entity_pads_init(&va->sd.entity,
 				      NR_OF_TI960_PADS, va->pad);
-	if (rval) {
+	if (ret) {
 		dev_err(va->sd.dev,
 			"Failed to init media entity for ti960!\n");
 		goto failed_out;
@@ -1557,7 +1557,7 @@ static int ti960_register_subdev(struct ti960 *va)
 
 failed_out:
 	v4l2_ctrl_handler_free(&va->ctrl_handler);
-	return rval;
+	return ret;
 }
 
 static int ti960_init(struct ti960 *va)
diff --git a/drivers/media/pci/intel/ipu6/ipu6-isys-mcd-phy.c b/drivers/media/pci/intel/ipu6/ipu6-isys-mcd-phy.c
index f18e6fa9a8e2..ff291305ca3a 100644
--- a/drivers/media/pci/intel/ipu6/ipu6-isys-mcd-phy.c
+++ b/drivers/media/pci/intel/ipu6/ipu6-isys-mcd-phy.c
@@ -644,7 +644,8 @@ static int ipu6_isys_driver_port_to_phy_port(struct ipu6_isys_csi2_config *cfg)
 #if IS_ENABLED(CONFIG_VIDEO_INTEL_IPU_USE_PLATFORMDATA)
 static int ipu6_isys_mcd_phy_config(struct ipu6_isys *isys, struct ipu6_isys_csi2_config *cfg)
 {
-	unsigned int phy_port, phy_id;
+	unsigned int phy_id;
+	int phy_port;
 	void __iomem *phy_base;
 	struct ipu6_bus_device *adev = to_ipu6_bus_device(&isys->adev->auxdev.dev);
 	struct ipu6_device *isp = adev->isp;
-- 
2.34.1

